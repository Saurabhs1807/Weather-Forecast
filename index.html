<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weather Forecast App — Debug Friendly</title>
<style>
  :root{
    --bg:#0f1724; --card:#071126; --muted:#9aa3b2; --accent:#06b6d4;
    --glass: rgba(255,255,255,0.03);
    font-family: Inter, system-ui, Arial, sans-serif;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071126,#021025);color:#e6eef8;padding:18px}
  .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr 340px;gap:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .search{display:flex;gap:8px;margin-top:12px}
  input, select, button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  input[type="text"]{flex:1}
  .temp{font-size:46px;font-weight:700}
  .small{font-size:13px;color:var(--muted)}
  .forecast{display:flex;gap:8px;overflow:auto;padding-top:8px}
  .fcard{min-width:110px;border-radius:10px;padding:8px;background:var(--glass);text-align:center}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .fav-list{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:12px;font-size:13px}
  .logbox{background:rgba(0,0,0,0.25);padding:8px;border-radius:8px;margin-top:10px;font-family:monospace;font-size:12px;max-height:140px;overflow:auto;color:#e6eef8}
  @media (max-width:900px){ .wrap{grid-template-columns:1fr} .forecast{flex-wrap:nowrap} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Weather Forecast</h1>
      <div class="muted"> </div>
    </div>
    <div class="muted" id="clock"></div>
  </header>

  <main class="card">
    <div class="search">
      <input id="cityInput" type="text" placeholder="Enter city name (eg. Mumbai)" />
      <select id="units">
        <option value="metric">°C (Metric)</option>
        <option value="imperial">°F (Imperial)</option>
      </select>
      <button id="searchBtn">Search</button>
      <button id="geoBtn">Use My Location</button>
      <button id="demoBtn">Demo Data</button>
    </div>

    <div class="controls">
      <button id="saveFav" class="chip">Save Favorite</button>
      <div id="favList" class="fav-list"></div>
    </div>

    <section id="weatherArea" style="margin-top:12px">
      <div id="currentCard" class="card" style="padding:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="loc" style="font-weight:700;font-size:18px"></div>
            <div id="desc" class="small"></div>
          </div>
          <div class="temp" id="temp">--°</div>
        </div>
        <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
          <div class="small">Humidity: <span id="hum">--</span>%</div>
          <div class="small">Wind: <span id="wind">--</span></div>
          <div class="small">Sunrise: <span id="sunrise">--</span></div>
        </div>
      </div>

      <div id="forecastArea" class="card" style="margin-top:10px;display:none">
        <div class="small">5-day forecast (3-hour steps)</div>
        <div id="forecast" class="forecast"></div>
      </div>
    </section>

    <div class="card" style="margin-top:12px">
      <strong>Debug console (in-page)</strong>
      <div id="logbox" class="logbox">Logs will appear here. Also open DevTools (F12) for network details.</div>
    </div>
  </main>

  <aside class="card">
    <strong>About & Notes</strong>
    <div class="muted" style="margin-top:8px">
      • API key inserted. • If city not found, check spelling. • If 401 — API key problem (wait ~10–20 min or regenerate).<br>
      • For network/CORS issues run with VS Code Live Server.
    </div>
  </aside>

  <footer>Tip: Open DevTools → Network to inspect requests. Paste this URL in browser to test directly:<br><code>https://api.openweathermap.org/data/2.5/weather?q=Mumbai&units=metric&appid=d921edd59faa5010fa7fffbb309eb2a1</code></footer>
</div>

<script>
/* ========= CONFIG ========= */
const API_KEY = "d921edd59faa5010fa7fffbb309eb2a1";
/* ========================== */

const qs = s => document.querySelector(s);
const cityInput = qs('#cityInput');
const searchBtn = qs('#searchBtn');
const geoBtn = qs('#geoBtn');
const demoBtn = qs('#demoBtn');
const unitsSel = qs('#units');

const currentCard = qs('#currentCard');
const tempEl = qs('#temp');
const locEl = qs('#loc');
const descEl = qs('#desc');
const humEl = qs('#hum');
const windEl = qs('#wind');
const sunriseEl = qs('#sunrise');

const forecastArea = qs('#forecastArea');
const forecastEl = qs('#forecast');

const saveFavBtn = qs('#saveFav');
const favListEl = qs('#favList');

const clockEl = qs('#clock');
const logbox = qs('#logbox');

setInterval(()=> clockEl.textContent = new Date().toLocaleString(), 1000);

/* small logger to show messages on page + console */
function log(...args){
  console.log(...args);
  const text = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
  const p = document.createElement('div');
  p.textContent = (new Date()).toLocaleTimeString() + ' — ' + text;
  logbox.prepend(p);
  // keep max lines
  while(logbox.childElementCount > 80) logbox.removeChild(logbox.lastChild);
}

/* localStorage */
const LS_FAV = "weather_favorites";
function loadFavs(){
  const arr = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
  favListEl.innerHTML = "";
  arr.forEach(city => {
    const chip = document.createElement("button");
    chip.className = "chip";
    chip.textContent = city;
    chip.onclick = () => { cityInput.value = city; fetchByCity(city); };
    favListEl.appendChild(chip);
  });
}
function saveFav(city){
  if(!city) return alert("Enter a city to save as favorite");
  const arr = JSON.parse(localStorage.getItem(LS_FAV) || "[]");
  if(!arr.includes(city)) arr.push(city);
  localStorage.setItem(LS_FAV, JSON.stringify(arr));
  loadFavs();
}

/* format helper */
function formatTime(ts){
  return new Date(ts * 1000).toLocaleTimeString();
}
function show(el){ el.style.display = ""; }
function hide(el){ el.style.display = "none"; }

/* Renderers */
function renderCurrent(data){
  show(currentCard);
  show(forecastArea);
  locEl.textContent = `${data.name}, ${data.sys?.country || ''}`;
  descEl.textContent = data.weather?.[0]?.description || '';
  tempEl.textContent = Math.round(data.main?.temp) + (unitsSel.value === "metric" ? "°C" : "°F");
  humEl.textContent = data.main?.humidity ?? '--';
  windEl.textContent = (data.wind?.speed ?? '--') + (unitsSel.value === "metric" ? " m/s" : " mph");
  sunriseEl.textContent = data.sys?.sunrise ? formatTime(data.sys.sunrise) : '--';
}

function renderForecast(data){
  forecastEl.innerHTML = "";
  if(!data || !data.list) return;
  data.list.slice(0, 12).forEach(item => {
    const card = document.createElement("div");
    card.className = "fcard";
    const dt = new Date(item.dt * 1000);
    const time = dt.toLocaleString('en-IN', { weekday:'short', hour:'2-digit', minute:'2-digit' });
    const icon = item.weather?.[0]?.icon;
    const iconUrl = icon ? `https://openweathermap.org/img/wn/${icon}@2x.png` : '';
    card.innerHTML = `<div class="small">${time}</div>
      ${ iconUrl ? `<img src="${iconUrl}" style="width:48px">` : '' }
      <div style="font-weight:700">${Math.round(item.main.temp)}°</div>
      <div class="small">${item.weather?.[0]?.main || ''}</div>`;
    forecastEl.appendChild(card);
  });
}

/* ========== Improved fetch functions with robust error handling ========== */
async function fetchByCity(city){
  if(!city) return alert("Please enter a city name");
  const units = unitsSel.value;
  try{
    const url1 = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=${units}&appid=${API_KEY}`;
    log("Requesting current weather:", url1);
    const res1 = await fetch(url1);
    let cur;
    try { cur = await res1.json(); } catch(e){ log("Failed to parse JSON (current):", e); cur = null; }
    log("Current response status:", res1.status, cur);

    if(res1.status === 401){
      alert("API Key error (401). Check key or wait for activation.");
      return;
    }
    if(res1.status === 404 || (cur && (cur.cod === "404" || cur.cod === 404))){
      alert("City not found. Try different spelling (eg. Mumbai, New York).");
      return;
    }
    if(!res1.ok){
      alert("Error fetching current weather: " + (cur?.message || res1.status));
      return;
    }
    if(!cur || !cur.coord){
      alert("Invalid response for current weather. See console/log for details.");
      return;
    }

    renderCurrent(cur);

    const { lat, lon } = cur.coord;
    const url2 = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${units}&appid=${API_KEY}`;
    log("Requesting forecast:", url2);
    const res2 = await fetch(url2);
    let fore;
    try { fore = await res2.json(); } catch(e){ log("Failed to parse JSON (forecast):", e); fore = null; }
    log("Forecast response status:", res2.status, fore);

    if(res2.status === 401){
      alert("API Key error while fetching forecast (401).");
      return;
    }
    if(!res2.ok){
      alert("Error fetching forecast: " + (fore?.message || res2.status));
      return;
    }
    renderForecast(fore);

  }catch(err){
    log("fetchByCity exception:", err);
    alert("Network or unexpected error: " + err.message);
  }
}

async function fetchByCoords(lat, lon){
  if(lat == null || lon == null) return alert("Coordinates missing");
  const units = unitsSel.value;
  try{
    const url1 = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${units}&appid=${API_KEY}`;
    log("Requesting current (coords):", url1);
    const res1 = await fetch(url1);
    let cur;
    try { cur = await res1.json(); } catch(e){ cur = null; log("JSON parse fail (coords current):", e); }
    log("Current(coords) status:", res1.status, cur);
    if(!res1.ok){
      alert("Error fetching current by coords: " + (cur?.message || res1.status));
      return;
    }
    renderCurrent(cur);

    const url2 = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${units}&appid=${API_KEY}`;
    log("Requesting forecast (coords):", url2);
    const res2 = await fetch(url2);
    let fore;
    try { fore = await res2.json(); } catch(e){ fore = null; log("JSON parse fail (coords forecast):", e); }
    log("Forecast(coords) status:", res2.status, fore);
    if(!res2.ok){
      alert("Error fetching forecast by coords: " + (fore?.message || res2.status));
      return;
    }
    renderForecast(fore);

  }catch(err){
    log("fetchByCoords exception:", err);
    alert("Network or unexpected error: " + err.message);
  }
}
/* ======================================================================= */

/* Demo sample */
const sampleCurrent = {
  name: "Mumbai",
  sys: { country: "IN", sunrise: Math.floor(Date.now()/1000) - 3600 },
  weather: [{ description: "broken clouds", icon: "04d" }],
  main: { temp: 29, humidity: 72 },
  wind: { speed: 3.6 },
  coord: { lat: 19.07, lon: 72.87 }
};
const sampleForecast = {
  list: Array.from({length:8}).map((_,i)=>({
    dt: Math.floor(Date.now()/1000) + i*3*3600,
    main: { temp: 26 + i%5 },
    weather: [{ main: ['Clouds','Rain','Clear'][i%3], icon: ['04d','10d','01d'][i%3] }]
  }))
};

demoBtn.onclick = () => {
  log("Rendering demo data (no API calls).");
  renderCurrent(sampleCurrent);
  renderForecast(sampleForecast);
};

/* Events */
searchBtn.onclick = () => fetchByCity(cityInput.value.trim());
geoBtn.onclick = () => {
  if(!navigator.geolocation) return alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(
    pos => fetchByCoords(pos.coords.latitude, pos.coords.longitude),
    err => {
      log("Geolocation error:", err);
      alert("Unable to fetch location: " + err.message);
    }
  );
};
saveFavBtn.onclick = () => saveFav(cityInput.value.trim());
cityInput.addEventListener('keydown', e => { if(e.key === 'Enter') searchBtn.click(); });

/* init */
loadFavs();
log("App initialized. API key present. Try searching a city (eg. Mumbai).");

</script>
</body>
</html>
